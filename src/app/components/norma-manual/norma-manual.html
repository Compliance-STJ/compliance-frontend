<div class="norma-manual-container">
  <div class="header-section">
    <h1>ğŸ“ CriaÃ§Ã£o Inteligente de ObrigaÃ§Ãµes</h1>
    <p>Analise normas automaticamente e crie obrigaÃ§Ãµes de forma intuitiva</p>
  </div>

  <!-- Barra de progresso simplificada -->
  <div class="progress-bar" *ngIf="normaEstruturada">
    <div class="progress-step" [class.active]="normaEstruturada" [class.completed]="normaEstruturada">
      <div class="step-number">1</div>
      <div class="step-label">Analisar Norma</div>
    </div>
    <div class="progress-connector" [class.active]="normaEstruturada"></div>
    <div class="progress-step" [class.active]="normaValidada" [class.completed]="normaValidada">
      <div class="step-number">2</div>
      <div class="step-label">Validar Dados</div>
    </div>
    <div class="progress-connector" [class.active]="normaValidada"></div>
    <div class="progress-step" [class.active]="normaValidada" [class.completed]="obrigacoes.length > 0">
      <div class="step-number">3</div>
      <div class="step-label">Criar ObrigaÃ§Ãµes ({{ obrigacoes.length }})</div>
    </div>
  </div>

  <!-- Etapa 1: AnÃ¡lise da Norma -->
  <div *ngIf="!normaEstruturada" class="step-section">
    <div class="step-header">
      <h2>ğŸ” 1. Analisar Norma</h2>
      <p>Cole o texto da norma ou forneÃ§a uma URL para anÃ¡lise automÃ¡tica</p>
    </div>

    <div class="input-section">
      <div class="input-tabs">
        <button [class.active]="activeTab === 'texto'" (click)="activeTab = 'texto'">
          ğŸ“„ Inserir Texto
        </button>
        <button [class.active]="activeTab === 'url'" (click)="activeTab = 'url'">
          ğŸŒ Inserir URL
        </button>
      </div>

      <div class="input-content">
        <!-- Aba de texto -->
        <div *ngIf="activeTab === 'texto'" class="tab-content">
          <textarea
            [(ngModel)]="textoNorma"
            placeholder="Cole aqui o texto completo da norma jurÃ­dica...

Exemplo:
Lei nÂº 12.345 de 15 de janeiro de 2020
Conselho Nacional de JustiÃ§a

Art. 1Âº As unidades devem implementar programas de compliance..."
            rows="12"
            class="norma-textarea">
          </textarea>
          <div class="action-buttons">
            <button
              (click)="analisarTexto()"
              [disabled]="analisando || !textoNorma.trim()"
              class="btn-primary">
              <span *ngIf="analisando">ğŸ” Analisando...</span>
              <span *ngIf="!analisando">ğŸš€ Analisar Norma</span>
            </button>
          </div>
        </div>

        <!-- Aba de URL -->
        <div *ngIf="activeTab === 'url'" class="tab-content">
          <input
            type="url"
            [(ngModel)]="urlNorma"
            placeholder="Ex: atos.cnj.jus.br/atos/detalhar/6344 ou https://atos.cnj.jus.br/atos/detalhar/6344"
            class="url-input">
          <small class="field-help">ğŸ’¡ Cole a URL completa ou apenas o endereÃ§o (adicionaremos https:// automaticamente)</small>
          <div class="action-buttons">
            <button
              (click)="analisarUrl()"
              [disabled]="analisando || !urlNorma.trim()"
              class="btn-primary">
              <span *ngIf="analisando">ğŸŒ Analisando...</span>
              <span *ngIf="!analisando">ğŸš€ Analisar por URL</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Etapa 2: ValidaÃ§Ã£o dos Dados ExtraÃ­dos -->
  <div *ngIf="normaEstruturada && !normaValidada" class="step-section">
    <div class="step-header">
      <h2>âœ… 2. Validar Dados ExtraÃ­dos</h2>
      <p>Confirme ou ajuste os dados extraÃ­dos automaticamente da norma</p>
    </div>

    <div class="validation-section">
      <div class="norma-preview">
        <h3>ğŸ“‹ Norma Identificada</h3>
        <div class="norma-info-card">
          <div class="norma-title">{{ normaNome || 'TÃ­tulo nÃ£o identificado' }}</div>
          <div class="extraction-status">
            <div class="status-indicator" [class.extracted]="normaNome" [class.manual]="!normaNome">
              <span class="status-icon">{{ normaNome ? 'âœ…' : 'âš ï¸' }}</span>
              <span class="status-text">{{ normaNome ? 'ExtraÃ­do automaticamente' : 'Preenchimento manual necessÃ¡rio' }}</span>
            </div>
          </div>
          <div class="norma-details">
            <div class="detail-item">
              <span class="detail-label">Data:</span>
              <span class="detail-value" [class.extracted]="normaDataNorma" [class.manual]="!normaDataNorma">
                {{ normaDataNorma || 'NÃ£o identificada' }}
              </span>
              <span class="extraction-icon">{{ normaDataNorma ? 'ğŸ¤–' : 'âœï¸' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ã“rgÃ£o:</span>
              <span class="detail-value" [class.extracted]="normaOrgaoEmissor" [class.manual]="!normaOrgaoEmissor">
                {{ normaOrgaoEmissor || 'NÃ£o identificado' }}
              </span>
              <span class="extraction-icon">{{ normaOrgaoEmissor ? 'ğŸ¤–' : 'âœï¸' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Categoria:</span>
              <span class="detail-value" [class.extracted]="normaCategoria" [class.manual]="!normaCategoria">
                {{ normaCategoria || 'NÃ£o identificada' }}
              </span>
              <span class="extraction-icon">{{ normaCategoria ? 'ğŸ¤–' : 'âœï¸' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="norma-form">
        <h3>âœï¸ Ajustar Dados (se necessÃ¡rio)</h3>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>IdentificaÃ§Ã£o *</label>
            <input
              type="text"
              [(ngModel)]="normaNome"
              placeholder="Ex: Lei nÂº 12.345 de 15 de outubro de 2023"
              class="form-input">
            <small class="field-help">Este campo deve conter o nome completo da norma incluindo a data</small>
          </div>
          <div class="form-group">
            <label>Data da Norma *</label>
            <input
              type="date"
              [(ngModel)]="normaDataNorma"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Ã“rgÃ£o Emissor</label>
            <input
              type="text"
              [(ngModel)]="normaOrgaoEmissor"
              placeholder="Ex: Conselho Nacional de JustiÃ§a"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Categoria</label>
            <input
              type="text"
              [(ngModel)]="normaCategoria"
              placeholder="Ex: Compliance, GestÃ£o"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Origem</label>
            <select [(ngModel)]="normaOrigemId" class="form-select">
              <option [value]="undefined">Selecione...</option>
              <option value="1">CNJ</option>
              <option value="2">STJ</option>
              <option value="3">LegislaÃ§Ã£o Federal</option>
            </select>
          </div>
        </div>

        <div class="form-group full-width">
          <label>Link da Norma</label>
          <input
            type="url"
            [(ngModel)]="normaLink"
            placeholder="https://..."
            class="form-input">
        </div>

        <div class="form-group full-width">
          <label>DescriÃ§Ã£o</label>
          <textarea
            [(ngModel)]="normaDescricao"
            placeholder="Breve descriÃ§Ã£o da norma..."
            rows="2"
            class="form-textarea">
          </textarea>
        </div>

        <div class="validation-actions">
          <button (click)="voltarParaAnalise()" class="btn-secondary">
            â† Voltar para AnÃ¡lise
          </button>
          <button
            (click)="confirmarNorma()"
            [disabled]="!normaNome?.trim() || !normaDataNorma"
            class="btn-primary">
            âœ… Confirmar e Continuar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Etapa 3: CriaÃ§Ã£o de ObrigaÃ§Ãµes -->
  <div *ngIf="normaValidada" class="step-section">
    <div class="step-header">
      <h2>âš¡ 3. Criar ObrigaÃ§Ãµes</h2>
      <p>Selecione partes da norma e crie obrigaÃ§Ãµes de forma intuitiva</p>
    </div>

    <div class="creation-section">
      <div class="norma-structure-panel">
        <div class="panel-header">
          <h3>ğŸ“– Estrutura da Norma</h3>
          <div class="panel-controls">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="mostrarApenasSelecionadas">
              Mostrar apenas selecionadas
            </label>
            <button
              *ngIf="partesSelecionadas.length > 0"
              (click)="limparSelecao()"
              class="btn-secondary">
              ğŸ—‘ï¸ Limpar SeleÃ§Ã£o
            </button>
          </div>
        </div>

        <div class="partes-tree">
          <app-parte-norma-tree-item
            *ngFor="let parte of getPartesExibidas()"
            [parte]="parte"
            (selecaoChange)="onSelecaoChange($event)">
          </app-parte-norma-tree-item>
        </div>
      </div>

      <div class="obligation-creation-panel">
        <div class="panel-header">
          <h3>âœï¸ Criar ObrigaÃ§Ã£o</h3>
          <div class="keyboard-shortcuts">
            <span class="shortcut">ğŸ’¾ <kbd>Ctrl</kbd>+<kbd>Enter</kbd> Adicionar</span>
            <span class="shortcut">ğŸ”„ <kbd>Ctrl</kbd>+<kbd>N</kbd> Nova</span>
            <span class="shortcut">ğŸš€ <kbd>Ctrl</kbd>+<kbd>S</kbd> Salvar Tudo</span>
          </div>
        </div>

        <!-- Quando nÃ£o hÃ¡ seleÃ§Ã£o -->
        <div *ngIf="partesSelecionadas.length === 0" class="no-selection-message">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <h4>Nenhuma parte selecionada</h4>
            <p>Clique nas partes da norma Ã  esquerda para selecionar o texto que serÃ¡ usado nesta obrigaÃ§Ã£o.</p>
          </div>
        </div>

        <!-- FormulÃ¡rio de criaÃ§Ã£o -->
        <div *ngIf="partesSelecionadas.length > 0" class="obligation-form">
          <div class="form-group">
            <label>TÃ­tulo da ObrigaÃ§Ã£o *</label>
            <input
              type="text"
              [(ngModel)]="tituloAtual"
              placeholder="Ex: Implementar programa de compliance"
              class="form-input"
              autofocus>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Tipo</label>
              <select [(ngModel)]="tipoAtual" class="form-select">
                <option value="determinacao">ğŸ“‹ DeterminaÃ§Ã£o</option>
                <option value="recomendacao">ğŸ’¡ RecomendaÃ§Ã£o</option>
              </select>
            </div>
            <div class="form-group">
              <label>Prioridade</label>
              <select [(ngModel)]="prioridadeAtual" class="form-select">
                <option value="baixa">ğŸŸ¢ Baixa</option>
                <option value="media">ğŸŸ¡ MÃ©dia</option>
                <option value="alta">ğŸŸ  Alta</option>
                <option value="critica">ğŸ”´ CrÃ­tica</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>DescriÃ§Ã£o</label>
            <textarea
              [(ngModel)]="descricaoAtual"
              placeholder="DescriÃ§Ã£o detalhada da obrigaÃ§Ã£o..."
              rows="3"
              class="form-textarea">
            </textarea>
          </div>

          <!-- SeleÃ§Ã£o de unidades responsÃ¡veis -->
          <div class="form-group">
            <label>Unidades ResponsÃ¡veis</label>
            <div class="unidades-selector">
              <!-- Unidades selecionadas -->
              <div class="unidades-selecionadas" *ngIf="unidadesSelecionadas.length > 0">
                <div class="unidade-tag" *ngFor="let unidade of unidadesSelecionadas">
                  <span class="unidade-nome">{{ unidade.sigla }} - {{ unidade.nome }}</span>
                  <button 
                    (click)="removerUnidade(unidade)"
                    class="btn-remover-unidade"
                    title="Remover unidade">
                    Ã—
                  </button>
                </div>
              </div>

              <!-- Seletor de unidades disponÃ­veis -->
              <div class="unidades-disponiveis">
                <select 
                  (change)="onUnidadeSelecionada($event)"
                  class="form-select">
                  <option value="" disabled selected>â• Adicionar unidade responsÃ¡vel...</option>
                  <option 
                    *ngFor="let unidade of getUnidadesDisponiveis()" 
                    [value]="unidade.id">
                    {{ unidade.sigla }} - {{ unidade.nome }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- Preview do texto compilado -->
          <div class="text-preview" *ngIf="textoCompiladoAtual">
            <div class="preview-header">
              <span class="preview-label">ğŸ“„ Texto Compilado:</span>
              <button
                (click)="togglePreviewExpandido()"
                class="btn-toggle-preview">
                {{ previewExpandido ? 'ğŸ”½ Recolher' : 'ğŸ”¼ Expandir' }}
              </button>
            </div>
            <div class="preview-content" [class.expanded]="previewExpandido">
              <div class="texto-compilado">{{ textoCompiladoAtual }}</div>
            </div>
          </div>

          <div class="form-actions">
            <button (click)="cancelarObrigacaoAtual()" class="btn-secondary">
              âŒ Cancelar
            </button>
            <button
              (click)="adicionarObrigacao()"
              [disabled]="!tituloAtual?.trim()"
              class="btn-primary">
              â• Adicionar ObrigaÃ§Ã£o
            </button>
          </div>
        </div>
      </div>

      <!-- Lista de obrigaÃ§Ãµes criadas -->
      <div class="obligations-list-panel" *ngIf="obrigacoes.length > 0">
        <div class="panel-header">
          <h3>ğŸ“ ObrigaÃ§Ãµes Criadas ({{ obrigacoes.length }})</h3>
        </div>

        <div class="obligations-list">
          <div *ngFor="let obrigacao of obrigacoes; let i = index" class="obligation-card">
            <div class="obligation-header">
              <div class="obligation-title-section">
                <span class="obligation-number">#{{ i + 1 }}</span>
                <h4 class="obligation-title">{{ obrigacao.titulo }}</h4>
              </div>
              <div class="obligation-badges">
                <span [class]="'badge tipo-' + obrigacao.tipo">
                  {{ obrigacao.tipo === 'determinacao' ? 'DeterminaÃ§Ã£o' : 'RecomendaÃ§Ã£o' }}
                </span>
                <span [class]="'badge prioridade-' + obrigacao.prioridade">
                  {{ getPrioridadeLabel(obrigacao.prioridade) }}
                </span>
              </div>
            </div>

            <div class="obligation-content">
              <p class="obligation-description" *ngIf="obrigacao.descricao">
                {{ obrigacao.descricao }}
              </p>
              <div class="obligation-meta">
                <span class="meta-item">{{ obrigacao.partesSelecionadas.length }} partes selecionadas</span>
                <span class="meta-item">{{ obrigacao.textoCompilado.length }} caracteres</span>
                <span class="meta-item" *ngIf="obrigacao.unidadesSelecionadas.length > 0">
                  {{ obrigacao.unidadesSelecionadas.length }} unidade{{ obrigacao.unidadesSelecionadas.length > 1 ? 's' : '' }} responsÃ¡vel{{ obrigacao.unidadesSelecionadas.length > 1 ? 'is' : '' }}
                </span>
              </div>
            </div>

            <div class="obligation-actions">
              <button (click)="editarObrigacao(obrigacao)" class="btn-edit">
                âœï¸ Editar
              </button>
              <button (click)="removerObrigacao(obrigacao)" class="btn-remove">
                ğŸ—‘ï¸ Remover
              </button>
            </div>
          </div>
        </div>

        <!-- AÃ§Ãµes finais -->
        <div class="final-actions">
          <button (click)="voltarParaValidacao()" class="btn-secondary">
            â† Voltar para ValidaÃ§Ã£o
          </button>
          <button
            (click)="salvarTudo()"
            [disabled]="obrigacoes.length === 0"
            class="btn-primary-large">
            ğŸš€ Salvar Norma e Todas as ObrigaÃ§Ãµes ({{ obrigacoes.length }})
          </button>
        <!-- Modal de confirmaÃ§Ã£o de salvamento -->
        <div *ngIf="mostrarConfirmacaoSalvar" class="modal-overlay" (click)="fecharConfirmacaoSalvar()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>ğŸš€ Confirmar Salvamento</h3>
              <button (click)="fecharConfirmacaoSalvar()" class="modal-close">&times;</button>
            </div>

            <div class="modal-body">
              <div class="save-summary">
                <div class="summary-item">
                  <span class="summary-label">Norma:</span>
                  <span class="summary-value">{{ normaNome }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">ObrigaÃ§Ãµes:</span>
                  <span class="summary-value">{{ obrigacoes.length }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Total de partes:</span>
                  <span class="summary-value">{{ getTotalPartesSelecionadas() }}</span>
                </div>
              </div>

              <div class="obligations-preview">
                <h4>ObrigaÃ§Ãµes a serem criadas:</h4>
                <div class="obligations-list-preview">
                  <div *ngFor="let obrigacao of obrigacoes; let i = index" class="obligation-preview-item">
                    <span class="obligation-number">#{{ i + 1 }}</span>
                    <span class="obligation-title">{{ obrigacao.titulo }}</span>
                    <span class="obligation-type" [class]="'tipo-' + obrigacao.tipo">
                      {{ obrigacao.tipo === 'determinacao' ? 'DET' : 'REC' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button (click)="fecharConfirmacaoSalvar()" class="btn-secondary">
                â† Voltar
              </button>
              <button (click)="confirmarSalvarTudo()" [disabled]="carregando" class="btn-primary">
                <span *ngIf="carregando">â³ Salvando...</span>
                <span *ngIf="!carregando">âœ… Confirmar e Salvar</span>
              </button>
            </div>
          </div>
        </div>
      <div class="help-steps">
        <div class="help-step">
          <div class="help-step-number">1</div>
          <div class="help-step-content">
            <h4>Insira uma Norma</h4>
            <p>Cole o texto da norma jurÃ­dica ou forneÃ§a uma URL para anÃ¡lise automÃ¡tica.</p>
          </div>
        </div>
        <div class="help-step">
          <div class="help-step-number">2</div>
          <div class="help-step-content">
            <h4>Selecione as Partes</h4>
            <p>O sistema identifica artigos, parÃ¡grafos, incisos e alÃ­neas. Marque apenas o que for relevante.</p>
          </div>
        </div>
        <div class="help-step">
          <div class="help-step-number">3</div>
          <div class="help-step-content">
            <h4>Crie ObrigaÃ§Ãµes</h4>
            <p>Monte obrigaÃ§Ãµes customizadas com o texto compilado automaticamente.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="features-grid">
      <div class="feature-card">
        <div class="feature-icon">ğŸ¯</div>
        <h4>SeleÃ§Ã£o Precisa</h4>
        <p>Escolha exatamente quais partes da norma usar para cada obrigaÃ§Ã£o.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ”„</div>
        <h4>ReordenaÃ§Ã£o</h4>
        <p>Arraste e solte para reorganizar as partes selecionadas.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ“</div>
        <h4>MÃºltiplas ObrigaÃ§Ãµes</h4>
        <p>Crie vÃ¡rias obrigaÃ§Ãµes diferentes a partir da mesma norma.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">âš¡</div>
        <h4>AnÃ¡lise AutomÃ¡tica</h4>
        <p>IdentificaÃ§Ã£o automÃ¡tica da estrutura jurÃ­dica da norma.</p>
      </div>
    </div>
  </div>
  <div class="input-section">
  <div *ngIf="obrigacaoAtual" class="edicao-section">
    <h2>3. Criar ObrigaÃ§Ã£o</h2>

    <div class="obrigacao-form">
      <div class="form-row">
        <label>TÃ­tulo da ObrigaÃ§Ã£o:</label>
        <input
          type="text"
          [(ngModel)]="obrigacaoAtual.titulo"
          placeholder="Digite um tÃ­tulo descritivo para a obrigaÃ§Ã£o"
          class="form-input">
      </div>

      <div class="form-row">
        <label>Tipo:</label>
        <select [(ngModel)]="obrigacaoAtual.tipo" class="form-select">
          <option value="determinacao">DeterminaÃ§Ã£o</option>
          <option value="recomendacao">RecomendaÃ§Ã£o</option>
        </select>
      </div>

      <div class="form-row">
        <label>DescriÃ§Ã£o:</label>
        <textarea
          [(ngModel)]="obrigacaoAtual.descricao"
          placeholder="Descreva a obrigaÃ§Ã£o em detalhes"
          rows="3"
          class="form-textarea">
        </textarea>
      </div>

      <div class="form-row">
        <label>Texto Compilado:</label>
        <div class="texto-compilado">
          {{ obrigacaoAtual.textoCompilado || 'Selecione partes da norma para gerar o texto...' }}
        </div>
      </div>

      <div class="form-actions">
        <button
          (click)="salvarObrigacao()"
          [disabled]="!obrigacaoAtual.titulo.trim()"
          class="btn-primary">
          ğŸ’¾ Salvar ObrigaÃ§Ã£o
        </button>
        <button
          (click)="cancelarObrigacao()"
          class="btn-secondary">
          âŒ Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- SeÃ§Ã£o de obrigaÃ§Ãµes criadas -->
  <div *ngIf="obrigacoes.length > 0" class="obrigacoes-section">
    <h2>4. ObrigaÃ§Ãµes Criadas ({{ obrigacoes.length }})</h2>

    <div class="obrigacoes-lista">
      <div *ngFor="let obrigacao of obrigacoes" class="obrigacao-card">
        <div class="obrigacao-header">
          <h3>{{ obrigacao.titulo }}</h3>
          <span [class]="'tipo-badge tipo-' + obrigacao.tipo">
            {{ obrigacao.tipo === 'determinacao' ? 'DeterminaÃ§Ã£o' : 'RecomendaÃ§Ã£o' }}
          </span>
        </div>

        <p *ngIf="obrigacao.descricao" class="obrigacao-descricao">
          {{ obrigacao.descricao }}
        </p>

        <div class="obrigacao-texto">
          <strong>Texto:</strong> {{ obrigacao.textoCompilado }}
        </div>

        <div class="obrigacao-partes">
          <strong>Partes selecionadas:</strong> {{ obrigacao.partesSelecionadas.length }}
        </div>

        <div class="obrigacao-actions">
          <button
            (click)="removerObrigacao(obrigacao)"
            class="btn-danger">
            ğŸ—‘ï¸ Remover
          </button>
        </div>
      </div>
    </div>

    <div class="acoes-finais">
      <button class="btn-primary btn-large">
        ğŸš€ Salvar Todas as ObrigaÃ§Ãµes
      </button>
    </div>
  </div>
</div>
