<h2 mat-dialog-title>
  <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
  {{ isEditMode ? 'Editar Evidência' : 'Nova Evidência' }}
</h2>

<mat-dialog-content>
  <div class="dialog-info">
    <mat-icon>business</mat-icon>
    <span><strong>Unidade:</strong> {{ data.unidadeNome }}</span>
  </div>

  <div *ngIf="erro" class="error-message">
    <mat-icon>error</mat-icon>
    {{ erro }}
  </div>

  <form class="evidencia-form">
    <!-- Tipo de Evidência -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Tipo de Evidência</mat-label>
      <mat-select
        [(ngModel)]="evidencia.tipo"
        name="tipo"
        (selectionChange)="onTipoChange()"
        required>
        <mat-option *ngFor="let tipo of tiposEvidencia" [value]="tipo.value">
          {{ tipo.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Título -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Título</mat-label>
      <input
        matInput
        [(ngModel)]="evidencia.titulo"
        name="titulo"
        placeholder="Digite o título da evidência"
        required
        maxlength="500">
      <mat-hint align="end">{{ evidencia.titulo?.length || 0 }}/500</mat-hint>
    </mat-form-field>

    <!-- Descrição -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Descrição (opcional)</mat-label>
      <textarea
        matInput
        [(ngModel)]="evidencia.descricao"
        name="descricao"
        placeholder="Descrição adicional sobre a evidência"
        rows="3"
        maxlength="1000"></textarea>
      <mat-hint align="end">{{ evidencia.descricao?.length || 0 }}/1000</mat-hint>
    </mat-form-field>

    <!-- Campo específico para TEXTO -->
    <mat-form-field
      *ngIf="evidencia.tipo === 'TEXTO'"
      appearance="outline"
      class="full-width">
      <mat-label>Conteúdo do Texto</mat-label>
      <textarea
        matInput
        [(ngModel)]="evidencia.conteudoTexto"
        name="conteudoTexto"
        placeholder="Digite o conteúdo da evidência"
        rows="6"
        required></textarea>
    </mat-form-field>

    <!-- Campo específico para LINK -->
    <mat-form-field
      *ngIf="evidencia.tipo === 'LINK'"
      appearance="outline"
      class="full-width">
      <mat-label>URL do Link</mat-label>
      <input
        matInput
        [(ngModel)]="evidencia.linkUrl"
        name="linkUrl"
        type="url"
        placeholder="https://exemplo.com"
        required>
      <mat-icon matPrefix>link</mat-icon>
    </mat-form-field>

    <!-- Campo específico para ARQUIVO -->
    <div *ngIf="evidencia.tipo === 'ARQUIVO'" class="arquivo-container">
      <input
        type="file"
        #fileInput
        (change)="onArquivoSelecionado($event)"
        style="display: none"
        accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt">

      <!-- Área de drag and drop -->
      <div
        *ngIf="!arquivoSelecionado"
        class="arquivo-dropzone"
        [class.dragging]="isDragging"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()">

        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <p class="upload-text">
          <strong>Arraste e solte o arquivo aqui</strong><br>
          ou clique para selecionar
        </p>
        <div class="file-types-info">
          <mat-chip-set>
            <mat-chip disabled>
              <mat-icon>picture_as_pdf</mat-icon>
              PDF
            </mat-chip>
            <mat-chip disabled>
              <mat-icon>description</mat-icon>
              Word
            </mat-chip>
            <mat-chip disabled>
              <mat-icon>table_chart</mat-icon>
              Excel
            </mat-chip>
            <mat-chip disabled>
              <mat-icon>image</mat-icon>
              Imagem
            </mat-chip>
          </mat-chip-set>
        </div>
        <p class="file-size-limit">Tamanho máximo: 10MB</p>
      </div>

      <!-- Arquivo selecionado -->
      <div *ngIf="arquivoSelecionado" class="arquivo-selecionado">
        <!-- Preview para imagens -->
        <div *ngIf="previewUrl" class="image-preview">
          <img [src]="previewUrl" alt="Preview">
        </div>

        <!-- Informações do arquivo -->
        <div class="arquivo-info-card">
          <div class="arquivo-header">
            <mat-icon [style.color]="getFileColor()">{{ getFileIcon() }}</mat-icon>
            <div class="arquivo-details">
              <h4>{{ arquivoSelecionado.name }}</h4>
              <p>{{ formatarTamanho(arquivoSelecionado.size) }}</p>
            </div>
            <button
              mat-icon-button
              (click)="removerArquivo()"
              matTooltip="Remover arquivo"
              type="button">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Botão para trocar arquivo -->
        <button
          mat-stroked-button
          type="button"
          (click)="fileInput.click()"
          class="change-file-btn">
          <mat-icon>sync</mat-icon>
          Trocar Arquivo
        </button>
      </div>

      <div *ngIf="isEditMode && !arquivoSelecionado" class="arquivo-edit-hint">
        <mat-icon>info</mat-icon>
        <span>Selecione um novo arquivo para substituir o existente (opcional)</span>
      </div>
    </div>
  </form>

  <div *ngIf="carregando" class="loading-overlay">
    <mat-spinner diameter="40"></mat-spinner>
    <p>{{ evidencia.tipo === 'ARQUIVO' ? 'Fazendo upload...' : 'Salvando...' }}</p>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancelar()" [disabled]="carregando">
    Cancelar
  </button>
  <button
    mat-raised-button
    color="primary"
    (click)="salvar()"
    [disabled]="carregando">
    <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
    {{ isEditMode ? 'Salvar' : 'Adicionar' }}
  </button>
</mat-dialog-actions>
